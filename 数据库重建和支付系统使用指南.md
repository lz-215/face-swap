# æ•°æ®åº“é‡å»ºå’Œè®¢é˜…ç§¯åˆ†ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨å®Œå…¨é‡å»º AIFaceSwap é¡¹ç›®çš„æ•°æ®åº“ï¼Œå¹¶é…ç½®çº¯è®¢é˜…ç§¯åˆ†ç³»ç»Ÿã€‚æ–°ç³»ç»ŸåŒ…å«ï¼š

- **æœˆè®¢é˜…**ï¼š16.9ç¾é‡‘ï¼ˆ120ç§¯åˆ†ï¼‰
- **å¹´è®¢é˜…**ï¼š118.8ç¾é‡‘ï¼ˆ1800ç§¯åˆ†ï¼‰
- **ç§¯åˆ†è¿‡æœŸæœºåˆ¶**ï¼šè®¢é˜…ç§¯åˆ†åˆ°æœŸè‡ªåŠ¨è¿‡æœŸ
- **æ™ºèƒ½æ¶ˆè´¹ç­–ç•¥**ï¼šä¼˜å…ˆä½¿ç”¨å³å°†è¿‡æœŸçš„è®¢é˜…ç§¯åˆ†

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šå¤‡ä»½ç°æœ‰æ•°æ®ï¼ˆé‡è¦ï¼ï¼‰

åœ¨æ‰§è¡Œé‡å»ºä¹‹å‰ï¼Œè¯·åŠ¡å¿…å¤‡ä»½ç°æœ‰æ•°æ®ï¼š

```bash
# å¯¼å‡ºç°æœ‰æ•°æ®
pg_dump your_database_url > backup_$(date +%Y%m%d_%H%M%S).sql

# æˆ–è€…ä½¿ç”¨ Supabase CLI
supabase db dump --file backup.sql
```

### ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œæ•°æ®åº“é‡å»º

âš ï¸ **è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰ç°æœ‰è¡¨å’Œæ•°æ®ï¼**

```sql
-- åœ¨ Supabase SQL Editor æˆ– psql ä¸­æ‰§è¡Œ
\i src/db/sql/rebuild-database.sql
```

### ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºæ”¯ä»˜å’Œç§¯åˆ†å‡½æ•°

```sql
-- åœ¨ Supabase SQL Editor æˆ– psql ä¸­æ‰§è¡Œ
\i src/db/sql/payment-functions.sql
```

### ç¬¬å››æ­¥ï¼šæµ‹è¯•ç³»ç»ŸåŠŸèƒ½

```sql
-- è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯ç³»ç»Ÿ
\i src/db/sql/test-payment-system.sql
```

## ğŸ“Š æ•°æ®åº“ç»“æ„è¯´æ˜

### æ ¸å¿ƒè¡¨ç»“æ„

1. **ç”¨æˆ·ç›¸å…³è¡¨**
   - `user` - ç”¨æˆ·åŸºç¡€ä¿¡æ¯
   - `user_settings` - ç”¨æˆ·è®¾ç½®
   - `user_credit_balance` - ç”¨æˆ·ç§¯åˆ†ä½™é¢

2. **ç§¯åˆ†ç³»ç»Ÿè¡¨**
   - `credit_package` - ç§¯åˆ†å¥—é¤ï¼ˆä»…è®¢é˜…ï¼‰
   - `credit_transaction` - ç§¯åˆ†äº¤æ˜“è®°å½•
   - `subscription_credits` - è®¢é˜…ç§¯åˆ†è·Ÿè¸ªï¼ˆæ¯ä¸ªè®¢é˜…æœŸçš„ç§¯åˆ†å’Œè¿‡æœŸæ—¶é—´ï¼‰
   - `credit_consumption_config` - ç§¯åˆ†æ¶ˆè´¹é…ç½®

3. **æ”¯ä»˜ç›¸å…³è¡¨**
   - `stripe_customer` - Stripe å®¢æˆ·ä¿¡æ¯
   - `stripe_subscription` - Stripe è®¢é˜…ä¿¡æ¯

4. **ä¸šåŠ¡åŠŸèƒ½è¡¨**
   - `face_swap_history` - äººè„¸äº¤æ¢å†å²
   - `uploads` - æ–‡ä»¶ä¸Šä¼ è®°å½•
   - `pending_bonus_credits` - å¾…å¤„ç†ç§¯åˆ†

### ç§¯åˆ†å¥—é¤é…ç½®

ç³»ç»Ÿé¢„ç½®äº†ä»¥ä¸‹è®¢é˜…å¥—é¤ï¼š

```sql
-- è®¢é˜…å¥—é¤
æœˆè®¢é˜…å¥—é¤: 120ç§¯åˆ† = $16.90/æœˆï¼ˆ30å¤©åè¿‡æœŸï¼‰
å¹´è®¢é˜…å¥—é¤: 1800ç§¯åˆ† = $118.80/å¹´ï¼ˆ365å¤©åè¿‡æœŸï¼‰
```

### å…³é”®å‡½æ•°è¯´æ˜

#### æ”¯ä»˜å¤„ç†å‡½æ•°

1. **`handle_subscription_payment_success`**
   - å¤„ç†è®¢é˜…æ”¯ä»˜æˆåŠŸäº‹ä»¶
   - åˆ›å»ºæœ‰æœŸé™çš„è®¢é˜…ç§¯åˆ†è®°å½•
   - è‡ªåŠ¨è¿‡æœŸæ—§çš„è®¢é˜…ç§¯åˆ†

```sql
-- ä½¿ç”¨ç¤ºä¾‹ï¼ˆæœˆè®¢é˜…ï¼‰
SELECT handle_subscription_payment_success(
  'sub_monthly_123',
  'user_id',
  120,
  'monthly',
  NOW(),
  NOW() + INTERVAL '30 days'
);

-- ä½¿ç”¨ç¤ºä¾‹ï¼ˆå¹´è®¢é˜…ï¼‰
SELECT handle_subscription_payment_success(
  'sub_yearly_456',
  'user_id',
  1800,
  'yearly',
  NOW(),
  NOW() + INTERVAL '365 days'
);
```

2. **`consume_credits`**
   - æ™ºèƒ½æ¶ˆè´¹ç§¯åˆ†
   - ä¼˜å…ˆä½¿ç”¨å³å°†è¿‡æœŸçš„è®¢é˜…ç§¯åˆ†

```sql
-- ä½¿ç”¨ç¤ºä¾‹
SELECT consume_credits('user_id', 1, 'äººè„¸äº¤æ¢æ“ä½œ');
```

3. **`expire_subscription_credits`**
   - å¤„ç†è¿‡æœŸçš„è®¢é˜…ç§¯åˆ†
   - è‡ªåŠ¨æ‰£é™¤è¿‡æœŸç§¯åˆ†å¹¶è®°å½•äº¤æ˜“

```sql
-- ä½¿ç”¨ç¤ºä¾‹
SELECT expire_subscription_credits();
```

## ğŸ”§ æ”¯ä»˜ç³»ç»Ÿé…ç½®

### Webhook é…ç½®

1. **Stripe Webhook ç«¯ç‚¹**
   - è®¢é˜…æ”¯ä»˜: `https://your-domain.com/api/webhooks/stripe-subscription`
   - äº‹ä»¶ç±»å‹: `invoice.payment_succeeded` - è®¢é˜…æ”¯ä»˜æˆåŠŸ

2. **æ”¯ä»˜æµç¨‹å›¾**

```mermaid
graph TD
    A[ç”¨æˆ·é€‰æ‹©è®¢é˜…å¥—é¤] --> B[åˆ›å»ºSubscription]
    B --> C[è®¢é˜…æ”¯ä»˜Webhook]
    C --> D[å†™å…¥è®¢é˜…ç§¯åˆ†]
    D --> E[è®¾ç½®è¿‡æœŸæ—¶é—´]
    E --> F[æ›´æ–°ç”¨æˆ·ä½™é¢]
```

3. **è®¢é˜…ç§¯åˆ†è¿‡æœŸæµç¨‹**

```mermaid
graph TD
    A[å®šæ—¶ä»»åŠ¡è¿è¡Œ] --> B[æŸ¥æ‰¾è¿‡æœŸç§¯åˆ†]
    B --> C{æœ‰è¿‡æœŸç§¯åˆ†?}
    C -->|æ˜¯| D[æ ‡è®°ç§¯åˆ†è¿‡æœŸ]
    C -->|å¦| E[ç»“æŸ]
    D --> F[æ‰£é™¤ç”¨æˆ·ä½™é¢]
    F --> G[è®°å½•è¿‡æœŸäº¤æ˜“]
    G --> H[å‘é€é€šçŸ¥]
    H --> E
```

### ç¯å¢ƒå˜é‡é…ç½®

ç¡®ä¿åœ¨æ‚¨çš„ `.env` æ–‡ä»¶ä¸­é…ç½®ä»¥ä¸‹å˜é‡ï¼š

```bash
# Supabase é…ç½®
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# Stripe é…ç½®
STRIPE_SECRET_KEY=your_stripe_secret_key
STRIPE_WEBHOOK_SECRET=your_webhook_secret

# äº§å“é…ç½®
STRIPE_MONTHLY_PRICE_ID=price_monthly_120_credits
STRIPE_YEARLY_PRICE_ID=price_yearly_1800_credits
```

## ğŸ” é—®é¢˜æ’æŸ¥

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. è®¢é˜…æ”¯ä»˜æˆåŠŸä½†ç§¯åˆ†æœªå¢åŠ 

**å¯èƒ½åŸå› :**
- è®¢é˜… Webhook æœªæ­£ç¡®é…ç½®
- è®¢é˜…æœŸé—´å·²å­˜åœ¨ç§¯åˆ†è®°å½•
- ç”¨æˆ·ID åŒ¹é…å¤±è´¥

**è§£å†³æ–¹æ¡ˆ:**
```sql
-- æ£€æŸ¥è®¢é˜…ç§¯åˆ†è®°å½•
SELECT * FROM subscription_credits 
WHERE user_id = 'user_id' 
ORDER BY created_at DESC;

-- æ‰‹åŠ¨å¤„ç†è®¢é˜…æ”¯ä»˜
SELECT handle_subscription_payment_success(
  'subscription_id',
  'user_id',
  120, -- æˆ– 1800
  'monthly', -- æˆ– 'yearly'
  period_start,
  period_end
);
```

#### 2. ç§¯åˆ†æœªæŒ‰æœŸè¿‡æœŸ

**è§£å†³æ–¹æ¡ˆ:**
```sql
-- æ‰‹åŠ¨æ‰§è¡Œè¿‡æœŸå¤„ç†
SELECT expire_subscription_credits();

-- æ£€æŸ¥è¿‡æœŸç§¯åˆ†çŠ¶æ€
SELECT 
  user_id,
  subscription_id,
  remaining_credits,
  end_date,
  status,
  CASE WHEN end_date < NOW() THEN 'SHOULD_EXPIRE' ELSE 'ACTIVE' END as should_be
FROM subscription_credits 
WHERE status = 'active';
```

#### 3. ç§¯åˆ†ä½™é¢ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ:**
```sql
-- éªŒè¯ç§¯åˆ†ä½™é¢ä¸€è‡´æ€§
WITH subscription_totals AS (
  SELECT 
    user_id,
    SUM(remaining_credits) as total_subscription_remaining
  FROM subscription_credits 
  WHERE status = 'active'
  GROUP BY user_id
)
SELECT 
  ucb.user_id,
  ucb.balance,
  COALESCE(st.total_subscription_remaining, 0) as calculated_balance,
  CASE 
    WHEN ucb.balance = COALESCE(st.total_subscription_remaining, 0)
    THEN 'CONSISTENT'
    ELSE 'INCONSISTENT'
  END as status
FROM user_credit_balance ucb
LEFT JOIN subscription_totals st ON ucb.user_id = st.user_id;
```

### ç›‘æ§å’Œæ—¥å¿—

#### 1. è®¢é˜…çŠ¶æ€ç›‘æ§

```sql
-- åˆ›å»ºè®¢é˜…ç§¯åˆ†ç›‘æ§è§†å›¾
CREATE VIEW subscription_credits_monitor AS
SELECT 
  sc.user_id,
  sc.subscription_id,
  sc.credits as total_credits,
  sc.remaining_credits,
  sc.start_date,
  sc.end_date,
  sc.status,
  CASE 
    WHEN sc.end_date < NOW() AND sc.status = 'active' THEN 'NEEDS_EXPIRATION'
    WHEN sc.end_date > NOW() AND sc.status = 'active' THEN 'ACTIVE'
    WHEN sc.status = 'expired' THEN 'EXPIRED'
    ELSE 'UNKNOWN'
  END as computed_status,
  ucb.balance as user_balance
FROM subscription_credits sc
LEFT JOIN user_credit_balance ucb ON sc.user_id = ucb.user_id
ORDER BY sc.end_date ASC;

-- æŸ¥çœ‹ç›‘æ§ä¿¡æ¯
SELECT * FROM subscription_credits_monitor;
```

#### 2. ç³»ç»Ÿå¥åº·æ£€æŸ¥

```sql
-- è¿è¡Œå®Œæ•´ç³»ç»Ÿå¥åº·æ£€æŸ¥
SELECT 
  'Total Users' as metric,
  COUNT(*) as value
FROM "user"
UNION ALL
SELECT 
  'Active Credit Balances' as metric,
  COUNT(*) as value
FROM user_credit_balance
UNION ALL
SELECT 
  'Active Subscription Credits' as metric,
  COUNT(*) as value
FROM subscription_credits WHERE status = 'active'
UNION ALL
SELECT 
  'Expired Subscription Credits' as metric,
  COUNT(*) as value
FROM subscription_credits WHERE status = 'expired'
UNION ALL
SELECT 
  'Today Transactions' as metric,
  COUNT(*) as value
FROM credit_transaction WHERE created_at >= CURRENT_DATE;
```

## ğŸ› ï¸ ç»´æŠ¤æ“ä½œ

### å®šæœŸç»´æŠ¤ä»»åŠ¡

#### 1. å®šæ—¶è¿‡æœŸç§¯åˆ†å¤„ç†

å»ºè®®è®¾ç½®æ¯å°æ—¶è¿è¡Œä¸€æ¬¡çš„å®šæ—¶ä»»åŠ¡ï¼š

```sql
-- åˆ›å»ºå®šæ—¶è¿‡æœŸå¤„ç†
SELECT scheduled_expire_credits();
```

æˆ–è€…åœ¨åº”ç”¨ç¨‹åºä¸­è®¾ç½® cron ä»»åŠ¡ï¼š

```javascript
// ä½¿ç”¨ node-cron
const cron = require('node-cron');

// æ¯å°æ—¶æ£€æŸ¥è¿‡æœŸç§¯åˆ†
cron.schedule('0 * * * *', async () => {
  try {
    const { data, error } = await supabase.rpc('scheduled_expire_credits');
    if (error) throw error;
    console.log('Expired credits processed:', data);
  } catch (error) {
    console.error('Error processing expired credits:', error);
  }
});
```

#### 2. æ¸…ç†è¿‡æœŸæ•°æ®

```sql
-- æ¸…ç†è¶…è¿‡30å¤©çš„è¿‡æœŸè®¢é˜…ç§¯åˆ†è®°å½•
DELETE FROM subscription_credits 
WHERE status = 'expired' 
  AND updated_at < NOW() - INTERVAL '30 days';
```

#### 3. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥

```sql
-- è¿è¡Œå®Œæ•´æ€§æ£€æŸ¥
DO $$
DECLARE
  orphaned_count INTEGER;
  negative_balance_count INTEGER;
BEGIN
  -- æ£€æŸ¥å­¤ç«‹çš„äº¤æ˜“è®°å½•
  SELECT COUNT(*) INTO orphaned_count
  FROM credit_transaction ct
  LEFT JOIN user_credit_balance ucb ON ct.user_id = ucb.user_id
  WHERE ucb.user_id IS NULL;
  
  -- æ£€æŸ¥è´Ÿä½™é¢
  SELECT COUNT(*) INTO negative_balance_count
  FROM user_credit_balance
  WHERE balance < 0;
  
  -- æŠ¥å‘Šç»“æœ
  IF orphaned_count > 0 THEN
    RAISE WARNING 'Found % orphaned transactions', orphaned_count;
  END IF;
  
  IF negative_balance_count > 0 THEN
    RAISE WARNING 'Found % negative balances', negative_balance_count;
  END IF;
  
  IF orphaned_count = 0 AND negative_balance_count = 0 THEN
    RAISE NOTICE 'Data integrity check passed âœ…';
  END IF;
END $$;
```

### æ€§èƒ½ä¼˜åŒ–

#### 1. ç´¢å¼•ç»´æŠ¤

```sql
-- æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT 
  schemaname,
  tablename,
  indexname,
  idx_scan as times_used,
  idx_tup_read as tuples_read,
  idx_tup_fetch as tuples_fetched
FROM pg_stat_user_indexes 
WHERE schemaname = 'public'
  AND tablename IN ('subscription_credits', 'credit_transaction', 'user_credit_balance')
ORDER BY idx_scan DESC;
```

#### 2. æŸ¥è¯¢æ€§èƒ½åˆ†æ

```sql
-- åˆ†æè®¢é˜…ç§¯åˆ†æŸ¥è¯¢æ€§èƒ½
EXPLAIN ANALYZE 
SELECT sc.*, ucb.balance
FROM subscription_credits sc
JOIN user_credit_balance ucb ON sc.user_id = ucb.user_id
WHERE sc.user_id = 'specific_user_id'
  AND sc.status = 'active'
ORDER BY sc.end_date ASC;
```

## ğŸ” å®‰å…¨è€ƒè™‘

### RLS ç­–ç•¥

ç³»ç»Ÿå·²é…ç½®å®Œæ•´çš„è¡Œçº§å®‰å…¨ç­–ç•¥ï¼š

1. **ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®**
2. **æœåŠ¡è§’è‰²å¯ä»¥ç®¡ç†æ‰€æœ‰æ•°æ®**
3. **è®¢é˜…ç§¯åˆ†æ•°æ®å—åˆ°é¢å¤–ä¿æŠ¤**

### å‡½æ•°å®‰å…¨

æ‰€æœ‰å…³é”®å‡½æ•°éƒ½ä½¿ç”¨ `SECURITY DEFINER` ç¡®ä¿ï¼š

1. **æƒé™æå‡æ‰§è¡Œ**
2. **ç»•è¿‡ RLS é™åˆ¶**
3. **äº‹åŠ¡å®‰å…¨æ€§**
4. **é˜²æ­¢SQLæ³¨å…¥**

## ğŸ“ API ä½¿ç”¨ç¤ºä¾‹

### åœ¨åº”ç”¨ä»£ç ä¸­ä½¿ç”¨

```typescript
// è·å–ç”¨æˆ·è¯¦ç»†ç§¯åˆ†ä¿¡æ¯
const { data } = await supabase.rpc('get_user_credits', {
  p_user_id: userId
});

// æ¶ˆè´¹ç§¯åˆ†ï¼ˆä¼˜å…ˆä½¿ç”¨å³å°†è¿‡æœŸçš„ç§¯åˆ†ï¼‰
const { data } = await supabase.rpc('consume_credits', {
  p_user_id: userId,
  p_amount: 1,
  p_description: 'Face swap operation'
});

// å¤„ç†è®¢é˜…æ”¯ä»˜æˆåŠŸ
const { data } = await supabase.rpc('handle_subscription_payment_success', {
  p_subscription_id: subscriptionId,
  p_user_id: userId,
  p_credits: 120, // æœˆè®¢é˜…
  p_subscription_period: 'monthly',
  p_current_period_start: periodStart,
  p_current_period_end: periodEnd
});

// æ£€æŸ¥å¹¶å¤„ç†è¿‡æœŸç§¯åˆ†
const { data } = await supabase.rpc('check_and_expire_credits', {
  p_user_id: userId // å¯é€‰ï¼Œä¸ºç©ºåˆ™å¤„ç†æ‰€æœ‰ç”¨æˆ·
});
```

### Webhook å¤„ç†ç¤ºä¾‹

```typescript
// å¤„ç†è®¢é˜…æ”¯ä»˜ webhook
app.post('/api/webhooks/stripe-subscription', async (req, res) => {
  const sig = req.headers['stripe-signature'];
  let event;

  try {
    event = stripe.webhooks.constructEvent(req.body, sig, process.env.STRIPE_WEBHOOK_SECRET);
  } catch (err) {
    return res.status(400).send(`Webhook signature verification failed.`);
  }

  if (event.type === 'invoice.payment_succeeded') {
    const invoice = event.data.object;
    const subscription = await stripe.subscriptions.retrieve(invoice.subscription);
    
    // è·å–ç”¨æˆ·ID
    const { data: userData } = await supabase.rpc('get_user_by_stripe_customer', {
      p_customer_id: subscription.customer
    });

    if (userData) {
      // ç¡®å®šç§¯åˆ†æ•°é‡
      const credits = subscription.items.data[0].price.id === process.env.STRIPE_MONTHLY_PRICE_ID ? 120 : 1800;
      const period = subscription.items.data[0].price.id === process.env.STRIPE_MONTHLY_PRICE_ID ? 'monthly' : 'yearly';

      // å¤„ç†è®¢é˜…æ”¯ä»˜
      const { data, error } = await supabase.rpc('handle_subscription_payment_success', {
        p_subscription_id: subscription.id,
        p_user_id: userData,
        p_credits: credits,
        p_subscription_period: period,
        p_current_period_start: new Date(subscription.current_period_start * 1000).toISOString(),
        p_current_period_end: new Date(subscription.current_period_end * 1000).toISOString()
      });

      if (error) {
        console.error('Error processing subscription payment:', error);
        return res.status(500).json({ error: 'Internal server error' });
      }
    }
  }

  res.json({ received: true });
});
```

## ğŸ“ æ”¯æŒ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. **æ£€æŸ¥æ—¥å¿—** - æŸ¥çœ‹ Supabase æ—¥å¿—å’Œåº”ç”¨æ—¥å¿—
2. **è¿è¡Œæµ‹è¯•** - æ‰§è¡Œ `test-payment-system.sql` éªŒè¯åŠŸèƒ½
3. **ç›‘æ§æ£€æŸ¥** - ä½¿ç”¨ç›‘æ§è§†å›¾æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
4. **æ•°æ®å¤‡ä»½** - ç¡®ä¿å®šæœŸå¤‡ä»½é‡è¦æ•°æ®
5. **è”ç³»æ”¯æŒ** - æä¾›å…·ä½“çš„é”™è¯¯ä¿¡æ¯å’Œå¤ç°æ­¥éª¤

---

**é‡è¦æé†’:**
- åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ‰§è¡Œé‡å»ºå‰åŠ¡å¿…å¤‡ä»½æ•°æ®
- æµ‹è¯•æ‰€æœ‰åŠŸèƒ½åå†ä¸Šçº¿
- è®¾ç½®å®šæ—¶ä»»åŠ¡å¤„ç†ç§¯åˆ†è¿‡æœŸ
- å®šæœŸç›‘æ§è®¢é˜…å’Œç§¯åˆ†ç³»ç»Ÿçš„è¿è¡ŒçŠ¶å†µ
- ä¿æŒç¯å¢ƒå˜é‡çš„å®‰å…¨æ€§
- ç¡®ä¿ Webhook ç«¯ç‚¹çš„å®‰å…¨æ€§ 