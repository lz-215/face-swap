# 支付积分系统修复与监控指南

## 一、系统原理与风险点

1. **支付成功后，必须有三条数据同步：**
   - `credit_recharge` 充值记录（status=completed）
   - `credit_transaction` 交易流水（type=recharge，关联充值ID）
   - `user_credit_balance` 用户积分余额（balance、total_recharged）

2. **常见风险：**
   - Stripe Webhook 受 RLS（行级安全）限制，无法写入数据
   - Webhook 处理失败，导致积分未到账
   - 数据库事务未生效，出现孤立充值记录
   - 并发/幂等性问题导致重复或漏记

---

## 二、诊断与修复流程

### 1. 诊断系统状态

运行诊断脚本，快速定位问题：

```bash
psql -h <host> -U <user> -d <db> -f diagnose_payment_issues.sql
```

重点关注：
- 孤立充值记录（充值已完成但无交易流水）
- 用户积分余额与流水不符
- webhook处理失败的记录
- RLS策略和RPC函数是否存在

---

### 2. 一键修复脚本

如发现异常，运行修复脚本：

```bash
psql -h <host> -U <user> -d <db> -f fix_payment_credits_manual.sql
```

**修复内容：**
- 自动补全RLS策略
- 创建/修复RPC函数
- 补全缺失的交易流水
- 重新计算并修正用户积分余额
- 创建监控视图

---

### 3. 管理员API与自动化

- 提供 `/api/admin/fix-credits` 管理员接口，支持一键修复、重试、余额重算等操作
- 支持API Key权限校验，保障安全
- 可通过curl或脚本自动调用

---

### 4. 定时监控与自动修复

- `scripts/monitor-payments.sh` 支持定时巡检、自动修复、异常告警（支持Slack）
- `setup-cron.sh` 一键设置crontab，每15分钟自动巡检
- 每周一上午9点自动生成详细报告

---

## 三、日常运维建议

1. **定期巡检：**  
   查看 `logs/payment-monitor.log`，关注孤立充值、卡住支付等异常。

2. **异常告警：**  
   配置Slack webhook，第一时间收到系统异常通知。

3. **手动干预：**  
   如遇大规模异常，可手动运行修复脚本或通过API修复。

4. **安全加固：**  
   管理员API务必加密，API Key妥善保管，避免泄露。

5. **代码升级建议：**  
   - Webhook处理务必使用事务和幂等性保护
   - 业务层优先调用RPC函数，确保RLS不影响后台处理
   - 监控视图和诊断脚本定期维护

---

## 四、常见问题FAQ

- **Q: 支付成功但用户未到账？**  
  A: 先运行诊断脚本，确认是否有孤立充值记录，再运行修复脚本。

- **Q: 余额与流水不符？**  
  A: 运行修复脚本自动重算余额，或用API重算单个用户。

- **Q: Webhook报RLS权限错误？**  
  A: 检查RLS策略和RPC函数，确保服务角色有权限。

- **Q: 如何手动修复单个充值？**  
  A: 用API `POST /api/admin/fix-credits`，参数 `{ action: "fix_specific_recharge", rechargeId: "..." }`

---

## 五、参考命令

**诊断：**
```bash
psql -h ... -U ... -d ... -f diagnose_payment_issues.sql
```

**一键修复：**
```bash
psql -h ... -U ... -d ... -f fix_payment_credits_manual.sql
```

**API修复：**
```bash
curl -X POST -H "Authorization: Bearer <admin-key>" -H "Content-Type: application/json" \
  -d '{"action":"fix_orphaned_recharges"}' http://localhost:3000/api/admin/fix-credits
```

**定时任务设置：**
```bash
bash setup-cron.sh
```

---

如需进一步帮助，请随时联系技术支持或查阅本指南！ 